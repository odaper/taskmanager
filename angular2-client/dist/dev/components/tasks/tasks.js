var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") return Reflect.decorate(decorators, target, key, desc);
    switch (arguments.length) {
        case 2: return decorators.reduceRight(function(o, d) { return (d && d(o)) || o; }, target);
        case 3: return decorators.reduceRight(function(o, d) { return (d && d(target, key)), void 0; }, void 0);
        case 4: return decorators.reduceRight(function(o, d) { return (d && d(target, key, o)) || o; }, desc);
    }
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var angular2_1 = require('angular2/angular2');
var AuthenticationService_1 = require('../../services/AuthenticationService');
var task_1 = require('components/tasks/task');
var TaskService_1 = require('../../services/TaskService');
var EventManager_1 = require("utils/eventbus/EventManager");
var forms_1 = require('angular2/forms');
var Tasks = (function () {
    function Tasks(authenticationService, taskService) {
        var _this = this;
        this.authenticationService = authenticationService;
        this.taskService = taskService;
        this.task = new task_1.Task();
        this.eventManager = EventManager_1.EventManager.getInstance();
        console.log("tasks.ts constructor");
        if (this.authenticationService.isLoggedIn()) {
            this.taskService.getTasks().then(function (obj) {
                console.log("tasks got: " + JSON.stringify(obj));
                _this.tasks = obj.actionResult;
                console.log("finished getting tasks: " + _this.tasks.length);
                _this.nrOfTasks = _this.tasks.length;
            }).catch(function (error) {
                _this.eventManager.publish("tasksResult", [false, error.message]);
            });
        }
        else {
            this.eventManager.publish("authenticationStateChange", [false, "You are not authenticated, please log in."]);
        }
    }
    Tasks.prototype.saveTask = function (event) {
        var _this = this;
        event.preventDefault();
        if (this.task && (this.task._id == null || this.task._id == undefined)) {
            var newTask = this.task;
            this.taskService.addTask(newTask).then(function (obj) {
                console.dir(obj);
                newTask.setId(obj.actionResult._id);
                console.log("before push: " + _this.tasks.length);
                _this.nrOfTasks = _this.tasks.push(newTask);
                _this.eventManager.publish("tasksResult", [true, "Added task '" + newTask.getId() + "'"]);
                _this.task = new task_1.Task();
            }).catch(function (error) {
                _this.eventManager.publish("tasksResult", [false, error.message]);
            });
        }
        else {
            this.taskService.updateTask(this.task).then(function (obj) {
                _this.eventManager.publish("tasksResult", [true, "Updated task '" + _this.task._id + "'"]);
                _this.task = new task_1.Task();
            }).catch(function (error) {
                _this.eventManager.publish("tasksResult", [false, error.message]);
            });
        }
    };
    Tasks.prototype.loadTask = function (event, task) {
        event.preventDefault();
        console.log("load task " + task._id);
        this.task = task;
    };
    Tasks.prototype.clearTask = function (event) {
        event.preventDefault();
        this.task = new task_1.Task();
    };
    Tasks.prototype.deleteTask = function (event) {
        var _this = this;
        event.preventDefault();
        console.log("tasks.ts delete " + this.task._id);
        this.taskService.deleteTask(this.task).then(function (obj) {
            _this.eventManager.publish("tasksResult", [true, "Deleted task '" + _this.task._id + "'"]);
            for (var i = 0, len = _this.tasks.length; i < len; i++) {
                var _task = _this.tasks[i];
                if (_task._id == _this.task._id) {
                    console.log("delete task with id " + _this.task._id + ", " + i);
                    _this.tasks.splice(i);
                }
            }
            _this.task = new task_1.Task();
        }).catch(function (error) {
            _this.eventManager.publish("tasksResult", [false, error.message]);
        });
    };
    Tasks = __decorate([
        angular2_1.Component({
            selector: 'component-2',
            viewInjector: [AuthenticationService_1.AuthenticationService, TaskService_1.TaskServiceRestImpl]
        }),
        angular2_1.View({
            templateUrl: './components/tasks/tasks.html?v=0.8.1',
            directives: [angular2_1.NgFor, angular2_1.NgIf, forms_1.formDirectives]
        }), 
        __metadata('design:paramtypes', [AuthenticationService_1.AuthenticationService, TaskService_1.TaskServiceRestImpl])
    ], Tasks);
    return Tasks;
})();
exports.Tasks = Tasks;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvdGFza3MvdGFza3MudHMiXSwibmFtZXMiOlsiVGFza3MiLCJUYXNrcy5jb25zdHJ1Y3RvciIsIlRhc2tzLnNhdmVUYXNrIiwiVGFza3MubG9hZFRhc2siLCJUYXNrcy5jbGVhclRhc2siLCJUYXNrcy5kZWxldGVUYXNrIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBLHlCQUEyQyxtQkFBbUIsQ0FBQyxDQUFBO0FBRS9ELHNDQUFvQyxzQ0FBc0MsQ0FBQyxDQUFBO0FBQzNFLHFCQUFtQix1QkFBdUIsQ0FBQyxDQUFBO0FBQzNDLDRCQUFrQyw0QkFBNEIsQ0FBQyxDQUFBO0FBQy9ELDZCQUEyQiw2QkFBNkIsQ0FBQyxDQUFBO0FBRXpELHNCQUE2QixnQkFBZ0IsQ0FBQyxDQUFBO0FBRTlDO0lBY0lBLGVBQW1CQSxxQkFBNENBLEVBQVNBLFdBQWdDQTtRQWQ1R0MsaUJBcUZDQTtRQXZFc0JBLDBCQUFxQkEsR0FBckJBLHFCQUFxQkEsQ0FBdUJBO1FBQVNBLGdCQUFXQSxHQUFYQSxXQUFXQSxDQUFxQkE7UUFKM0dBLFNBQUlBLEdBQVNBLElBQUlBLFdBQUlBLEVBQUVBLENBQUNBO1FBRWJBLGlCQUFZQSxHQUFpQkEsMkJBQVlBLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBO1FBRzVEQSxPQUFPQSxDQUFDQSxHQUFHQSxDQUFDQSxzQkFBc0JBLENBQUNBLENBQUNBO1FBRXBDQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxxQkFBcUJBLENBQUNBLFVBQVVBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1lBQzFDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxRQUFRQSxFQUFFQSxDQUFDQSxJQUFJQSxDQUFDQSxVQUFDQSxHQUFHQTtnQkFDcENBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLGFBQWFBLEdBQUdBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO2dCQUM5Q0EsS0FBSUEsQ0FBQ0Es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S0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDbEVBLENBQUNBLENBQUNBLENBQUNBO0lBQ0pBLENBQUNBO0lBcEZGTDtRQUFDQSxvQkFBU0EsQ0FBQ0E7WUFDUEEsUUFBUUEsRUFBRUEsYUFBYUE7WUFDdkJBLFlBQVlBLEVBQUVBLENBQUNBLDZDQUFxQkEsRUFBRUEsaUNBQW1CQSxDQUFDQTtTQUM3REEsQ0FBQ0E7UUFDREEsZUFBSUEsQ0FBQ0E7WUFDRkEsV0FBV0EsRUFBRUEsZ0RBQWdEQTtZQUM3REEsVUFBVUEsRUFBRUEsQ0FBQ0EsZ0JBQUtBLEVBQUVBLGVBQUlBLEVBQUVBLHNCQUFjQSxDQUFDQTtTQUM1Q0EsQ0FBQ0E7O2NBOEVEQTtJQUFEQSxZQUFDQTtBQUFEQSxDQXJGQSxBQXFGQ0EsSUFBQTtBQTdFWSxhQUFLLFFBNkVqQixDQUFBIiwiZmlsZSI6ImNvbXBvbmVudHMvdGFza3MvdGFza3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvbmVudCwgVmlldywgTmdGb3IsIE5nSWZ9IGZyb20gJ2FuZ3VsYXIyL2FuZ3VsYXIyJztcblxuaW1wb3J0IHtBdXRoZW50aWNhdGlvblNlcnZpY2V9IGZyb20gJy4uLy4uL3NlcnZpY2VzL0F1dGhlbnRpY2F0aW9uU2VydmljZSc7XG5pbXBvcnQge1Rhc2t9IGZyb20gJ2NvbXBvbmVudHMvdGFza3MvdGFzayc7XG5pbXBvcnQge1Rhc2tTZXJ2aWNlUmVzdEltcGx9IGZyb20gJy4uLy4uL3NlcnZpY2VzL1Rhc2tTZXJ2aWNlJztcbmltcG9ydCB7RXZlbnRNYW5hZ2VyfSBmcm9tIFwidXRpbHMvZXZlbnRidXMvRXZlbnRNYW5hZ2VyXCI7XG5cbmltcG9ydCB7Zm9ybURpcmVjdGl2ZXN9IGZyb20gJ2FuZ3VsYXIyL2Zvcm1zJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdjb21wb25lbnQtMicsXG4gICAgdmlld0luamVjdG9yOiBbQXV0aGVudGljYXRpb25TZXJ2aWNlLCBUYXNrU2VydmljZVJlc3RJbXBsXVxufSlcbkBWaWV3KHtcbiAgICB0ZW1wbGF0ZVVybDogJy4vY29tcG9uZW50cy90YXNrcy90YXNrcy5odG1sP3Y9PCU9IFZFUlNJT04gJT4nLFxuICAgIGRpcmVjdGl2ZXM6IFtOZ0ZvciwgTmdJZiwgZm9ybURpcmVjdGl2ZXNdXG59KVxuZXhwb3J0IGNsYXNzIFRhc2tzIHtcbiAgICB0YXNrczogQXJyYXk8VGFzaz47XG5cdHRhc2s6IFRhc2sgPSBuZXcgVGFzaygpO1xuXHRuck9mVGFza3M6IG51bWJlcjtcbiAgICBwcml2YXRlIGV2ZW50TWFuYWdlcjogRXZlbnRNYW5hZ2VyID0gRXZlbnRNYW5hZ2VyLmdldEluc3RhbmNlKCk7XG5cbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgYXV0aGVudGljYXRpb25TZXJ2aWNlOiBBdXRoZW50aWNhdGlvblNlcnZpY2UsIHB1YmxpYyB0YXNrU2VydmljZTogVGFza1NlcnZpY2VSZXN0SW1wbCkge1xuICAgICAgICBjb25zb2xlLmxvZyhcInRhc2tzLnRzIGNvbnN0cnVjdG9yXCIpO1xuXG4gICAgICAgIGlmICh0aGlzLmF1dGhlbnRpY2F0aW9uU2VydmljZS5pc0xvZ2dlZEluKCkpIHtcbiAgICAgICAgICAgIHRoaXMudGFza1NlcnZpY2UuZ2V0VGFza3MoKS50aGVuKChvYmopID0+IHtcblx0ICAgICAgICAgICAgY29uc29sZS5sb2coXCJ0YXNrcyBnb3Q6IFwiICsgSlNPTi5zdHJpbmdpZnkob2JqKSk7XG4gICAgICAgICAgICAgICAgdGhpcy50YXNrcyA9IG9iai5hY3Rpb25SZXN1bHQ7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJmaW5pc2hlZCBnZXR0aW5nIHRhc2tzOiBcIiArIHRoaXMudGFza3MubGVuZ3RoKTtcblx0ICAgICAgICAgICAgdGhpcy5uck9mVGFza3MgPSB0aGlzLnRhc2tzLmxlbmd0aDtcbiAgICAgICAgICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuXHQgICAgICAgICAgICB0aGlzLmV2ZW50TWFuYWdlci5wdWJsaXNoKFwidGFza3NSZXN1bHRcIiwgW2ZhbHNlLCBlcnJvci5tZXNzYWdlXSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcblx0ICAgICAgICB0aGlzLmV2ZW50TWFuYWdlci5wdWJsaXNoKFwiYXV0aGVudGljYXRpb25TdGF0ZUNoYW5nZVwiLCBbZmFsc2UsIFwiWW91IGFyZSBub3QgYXV0aGVudGljYXRlZCwgcGxlYXNlIGxvZyBpbi5cIl0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2F2ZVRhc2soZXZlbnQ6IGFueSk6IHZvaWQge1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOyAvLyBwcmV2ZW50IG5hdGl2ZSBwYWdlIHJlZnJlc2hcbiAgICAgICAgaWYgKHRoaXMudGFzayAmJiAodGhpcy50YXNrLl9pZCA9PSBudWxsIHx8IHRoaXMudGFzay5faWQgPT0gdW5kZWZpbmVkKSkge1xuXHQgICAgICAgIGxldCBuZXdUYXNrID0gdGhpcy50YXNrO1xuXHQgICAgICAgIHRoaXMudGFza1NlcnZpY2UuYWRkVGFzayhuZXdUYXNrKS50aGVuKChvYmopID0+IHtcblx0XHQgICAgICAgIGNvbnNvbGUuZGlyKG9iaik7XG5cdFx0ICAgICAgICBuZXdUYXNrLnNldElkKG9iai5hY3Rpb25SZXN1bHQuX2lkKTtcblx0XHQgICAgICAgIGNvbnNvbGUubG9nKFwiYmVmb3JlIHB1c2g6IFwiICsgdGhpcy50YXNrcy5sZW5ndGgpO1xuXHRcdCAgICAgICAgdGhpcy5uck9mVGFza3MgPSB0aGlzLnRhc2tzLnB1c2gobmV3VGFzayk7XG5cdFx0ICAgICAgICB0aGlzLmV2ZW50TWFuYWdlci5wdWJsaXNoKFwidGFza3NSZXN1bHRcIiwgW3RydWUsIFwiQWRkZWQgdGFzayAnXCIgKyBuZXdUYXNrLmdldElkKCkgKyBcIidcIl0pO1xuXHRcdCAgICAgICAgdGhpcy50YXNrID0gbmV3IFRhc2soKTtcblx0ICAgICAgICB9KS5jYXRjaCgoZXJyb3IpID0+IHtcblx0XHQgICAgICAgIHRoaXMuZXZlbnRNYW5hZ2VyLnB1Ymxpc2goXCJ0YXNrc1Jlc3VsdFwiLCBbZmFsc2UsIGVycm9yLm1lc3NhZ2VdKTtcblx0ICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcblx0ICAgICAgICB0aGlzLnRhc2tTZXJ2aWNlLnVwZGF0ZVRhc2sodGhpcy50YXNrKS50aGVuKChvYmopID0+IHtcblx0XHQgICAgICAgIHRoaXMuZXZlbnRNYW5hZ2VyLnB1Ymxpc2goXCJ0YXNrc1Jlc3VsdFwiLCBbdHJ1ZSwgXCJVcGRhdGVkIHRhc2sgJ1wiICsgdGhpcy50YXNrLl9pZCArIFwiJ1wiXSk7XG5cdFx0ICAgICAgICB0aGlzLnRhc2sgPSBuZXcgVGFzaygpO1xuXHQgICAgICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuXHRcdCAgICAgICAgdGhpcy5ldmVudE1hbmFnZXIucHVibGlzaChcInRhc2tzUmVzdWx0XCIsIFtmYWxzZSwgZXJyb3IubWVzc2FnZV0pO1xuXHQgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG5cdGxvYWRUYXNrKGV2ZW50OiBhbnksIHRhc2s6IFRhc2spOiB2b2lkIHtcblx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpOyAvLyBwcmV2ZW50IG5hdGl2ZSBwYWdlIHJlZnJlc2hcblx0XHRjb25zb2xlLmxvZyhcImxvYWQgdGFzayBcIiArIHRhc2suX2lkKTtcblx0XHR0aGlzLnRhc2sgPSB0YXNrO1xuXHR9XG5cblx0Y2xlYXJUYXNrKGV2ZW50OiBhbnkpOiB2b2lkIHtcblx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpOyAvLyBwcmV2ZW50IG5hdGl2ZSBwYWdlIHJlZnJlc2hcblx0XHR0aGlzLnRhc2sgPSBuZXcgVGFzaygpO1xuXHR9XG5cblx0ZGVsZXRlVGFzayhldmVudDogYW55KTogdm9pZCB7XG5cdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTsgLy8gcHJldmVudCBuYXRpdmUgcGFnZSByZWZyZXNoXG5cdFx0Y29uc29sZS5sb2coXCJ0YXNrcy50cyBkZWxldGUgXCIgKyB0aGlzLnRhc2suX2lkKTtcblx0XHR0aGlzLnRhc2tTZXJ2aWNlLmRlbGV0ZVRhc2sodGhpcy50YXNrKS50aGVuKChvYmopID0+IHtcblx0XHRcdHRoaXMuZXZlbnRNYW5hZ2VyLnB1Ymxpc2goXCJ0YXNrc1Jlc3VsdFwiLCBbdHJ1ZSwgXCJEZWxldGVkIHRhc2sgJ1wiICsgdGhpcy50YXNrLl9pZCArIFwiJ1wiXSk7XG5cdFx0XHQvLyBmaW5kSW5kZXggZG9lcyBub3Qgd29yayBvbiBUYXNrW11cblx0XHRcdC8vIHRoaXMudGFza3Muc3BsaWNlKHRoaXMudGFza3MuZmluZEluZGV4KF90YXNrID0+IF90YXNrLl9pZCA9PSB0aGlzLnRhc2suX2lkKSk7XG5cdFx0XHRmb3IgKGxldCBpID0gMCwgbGVuID0gdGhpcy50YXNrcy5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xuXHRcdFx0XHRsZXQgX3Rhc2sgPSB0aGlzLnRhc2tzW2ldO1xuXHRcdFx0XHRpZiAoX3Rhc2suX2lkID09IHRoaXMudGFzay5faWQpIHtcblx0XHRcdFx0XHRjb25zb2xlLmxvZyhcImRlbGV0ZSB0YXNrIHdpdGggaWQgXCIgKyB0aGlzLnRhc2suX2lkICsgXCIsIFwiICsgaSk7XG5cdFx0XHRcdFx0dGhpcy50YXNrcy5zcGxpY2UoaSk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHRcdHRoaXMudGFzayA9IG5ldyBUYXNrKCk7XG5cdFx0fSkuY2F0Y2goKGVycm9yKSA9PiB7XG5cdFx0XHR0aGlzLmV2ZW50TWFuYWdlci5wdWJsaXNoKFwidGFza3NSZXN1bHRcIiwgW2ZhbHNlLCBlcnJvci5tZXNzYWdlXSk7XG5cdFx0fSk7XG5cdH1cbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==