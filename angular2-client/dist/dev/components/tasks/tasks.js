var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") return Reflect.decorate(decorators, target, key, desc);
    switch (arguments.length) {
        case 2: return decorators.reduceRight(function(o, d) { return (d && d(o)) || o; }, target);
        case 3: return decorators.reduceRight(function(o, d) { return (d && d(target, key)), void 0; }, void 0);
        case 4: return decorators.reduceRight(function(o, d) { return (d && d(target, key, o)) || o; }, desc);
    }
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var angular2_1 = require('angular2/angular2');
var AuthenticationService_1 = require('../../services/AuthenticationService');
var task_1 = require('components/tasks/task');
var TaskServiceWebsockets_1 = require('../../services/TaskServiceWebsockets');
var EventManager_1 = require("utils/eventbus/EventManager");
var forms_1 = require('angular2/forms');
var Tasks = (function () {
    function Tasks(authenticationService, taskService) {
        var _this = this;
        this.authenticationService = authenticationService;
        this.taskService = taskService;
        this.task = new task_1.Task();
        this.eventManager = EventManager_1.EventManager.getInstance();
        console.log("tasks.ts constructor");
        if (this.authenticationService.isLoggedIn()) {
            this.taskService.sendMessage({ messageType: "GET_TASKS_FOR_USER" }).then(function (obj) {
                console.log("tasks got: " + JSON.stringify(obj));
                _this.tasks = obj;
                console.log("finished getting tasks: " + _this.tasks.length);
                _this.nrOfTasks = _this.tasks.length;
            }).catch(function (error) {
                _this.eventManager.publish("tasksResult", [false, error.message]);
            });
        }
        else {
            this.eventManager.publish("authenticationStateChange", [false, "You are not authenticated, please log in."]);
        }
    }
    Tasks.prototype.saveTask = function (event) {
        var _this = this;
        event.preventDefault();
        console.log("controller saveTask");
        if (this.task && (this.task._id == null || this.task._id == undefined)) {
            var newTask = this.task;
            console.log("hier");
            this.taskService.sendMessage(this.taskService.sendMessage({ messageType: "ADD_TASK", task: newTask }).then(function (obj) {
                console.dir(obj);
                newTask.setId(obj._id);
                console.log("before push: " + _this.tasks.length);
                _this.nrOfTasks = _this.tasks.push(newTask);
                _this.eventManager.publish("tasksResult", [true, "Added task '" + newTask.getId() + "'"]);
                _this.task = new task_1.Task();
            }).catch(function (error) {
                _this.eventManager.publish("tasksResult", [false, error.message]);
            }));
        }
        else {
            this.taskService.sendMessage(this.taskService.sendMessage({ messageType: "UPDATE_TASK", task: this.task }).then(function (obj) {
                _this.eventManager.publish("tasksResult", [true, "Updated task '" + _this.task._id + "'"]);
                _this.task = new task_1.Task();
            }).catch(function (error) {
                _this.eventManager.publish("tasksResult", [false, error.message]);
            }));
        }
    };
    Tasks.prototype.loadTask = function (event, task) {
        event.preventDefault();
        console.log("load task " + task._id);
        this.task = task;
    };
    Tasks.prototype.clearTask = function (event) {
        event.preventDefault();
        this.task = new task_1.Task();
    };
    Tasks.prototype.deleteTask = function (event) {
        var _this = this;
        event.preventDefault();
        console.log("tasks.ts delete " + this.task._id);
        this.taskService.sendMessage({ messageType: "DELETE_TASK", task: this.task }).then(function (obj) {
            _this.eventManager.publish("tasksResult", [true, "Deleted task '" + _this.task._id + "'"]);
            for (var i = 0, len = _this.tasks.length; i < len; i++) {
                var _task = _this.tasks[i];
                if (_task._id == _this.task._id) {
                    console.log("delete task with id " + _this.task._id + ", " + i);
                    _this.tasks.splice(i);
                }
            }
            _this.task = new task_1.Task();
        }).catch(function (error) {
            _this.eventManager.publish("tasksResult", [false, error.message]);
        });
    };
    Tasks = __decorate([
        angular2_1.Component({
            selector: 'component-2',
            viewInjector: [AuthenticationService_1.AuthenticationService, TaskServiceWebsockets_1.TaskServiceWebsockets]
        }),
        angular2_1.View({
            templateUrl: './components/tasks/tasks.html?v=0.7.0',
            directives: [angular2_1.NgFor, angular2_1.NgIf, forms_1.formDirectives]
        }), 
        __metadata('design:paramtypes', [AuthenticationService_1.AuthenticationService, TaskServiceWebsockets_1.TaskServiceWebsockets])
    ], Tasks);
    return Tasks;
})();
exports.Tasks = Tasks;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBvbmVudHMvdGFza3MvdGFza3MudHMiXSwibmFtZXMiOlsiVGFza3MiLCJUYXNrcy5jb25zdHJ1Y3RvciIsIlRhc2tzLnNhdmVUYXNrIiwiVGFza3MubG9hZFRhc2siLCJUYXNrcy5jbGVhclRhc2siLCJUYXNrcy5kZWxldGVUYXNrIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBLHlCQUEyQyxtQkFBbUIsQ0FBQyxDQUFBO0FBRS9ELHNDQUFvQyxzQ0FBc0MsQ0FBQyxDQUFBO0FBQzNFLHFCQUFtQix1QkFBdUIsQ0FBQyxDQUFBO0FBQzNDLHNDQUFvQyxzQ0FBc0MsQ0FBQyxDQUFBO0FBQzNFLDZCQUEyQiw2QkFBNkIsQ0FBQyxDQUFBO0FBRXpELHNCQUE2QixnQkFBZ0IsQ0FBQyxDQUFBO0FBRTlDO0lBY0lBLGVBQW1CQSxxQkFBNENBLEVBQVNBLFdBQWtDQTtRQWQ5R0MsaUJBdUZDQTtRQXpFc0JBLDBCQUFxQkEsR0FBckJBLHFCQUFxQkEsQ0FBdUJBO1FBQVNBLGdCQUFXQSxHQUFYQSxXQUFXQSxDQUF1QkE7UUFKN0dBLFNBQUlBLEdBQVNBLElBQUlBLFdBQUlBLEVBQUVBLENBQUNBO1FBRWJBLGlCQUFZQSxHQUFpQkEsMkJBQVlBLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBO1FBRzVEQSxPQUFPQSxDQUFDQSxHQUFHQSxDQUFDQSxzQkFBc0JBLENBQUNBLENBQUNBO1FBRXBDQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxxQkFBcUJBLENBQUNBLFVBQVVBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1lBQzFDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxXQUFXQSxDQUFDQSxFQUFDQSxXQUFXQSxFQUFFQSxvQkFBb0JBLEVBQUNBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFVBQUNBLEdBQUdBO2dCQUMxRUEsT0FBT0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsYUFBYUEsR0FBR0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsR0FBR0Es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c0JBLEdBQUdBLEtBQUlBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLEdBQUdBLElBQUlBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO29CQUMvREEsS0FBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3RCQSxDQUFDQTtZQUNGQSxDQUFDQTtZQUNEQSxLQUFJQSxDQUFDQSxJQUFJQSxHQUFHQSxJQUFJQSxXQUFJQSxFQUFFQSxDQUFDQTtRQUN4QkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsVUFBQ0EsS0FBS0E7WUFDZEEsS0FBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsYUFBYUEsRUFBRUEsQ0FBQ0EsS0FBS0EsRUFBRUEsS0FBS0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDbEVBLENBQUNBLENBQUNBLENBQUNBO0lBQ0pBLENBQUNBO0lBdEZGTDtRQUFDQSxvQkFBU0EsQ0FBQ0E7WUFDUEEsUUFBUUEsRUFBRUEsYUFBYUE7WUFDdkJBLFlBQVlBLEVBQUVBLENBQUNBLDZDQUFxQkEsRUFBRUEsNkNBQXFCQSxDQUFDQTtTQUMvREEsQ0FBQ0E7UUFDREEsZUFBSUEsQ0FBQ0E7WUFDRkEsV0FBV0EsRUFBRUEsZ0RBQWdEQTtZQUM3REEsVUFBVUEsRUFBRUEsQ0FBQ0EsZ0JBQUtBLEVBQUVBLGVBQUlBLEVBQUVBLHNCQUFjQSxDQUFDQTtTQUM1Q0EsQ0FBQ0E7O2NBZ0ZEQTtJQUFEQSxZQUFDQTtBQUFEQSxDQXZGQSxBQXVGQ0EsSUFBQTtBQS9FWSxhQUFLLFFBK0VqQixDQUFBIiwiZmlsZSI6ImNvbXBvbmVudHMvdGFza3MvdGFza3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvbmVudCwgVmlldywgTmdGb3IsIE5nSWZ9IGZyb20gJ2FuZ3VsYXIyL2FuZ3VsYXIyJztcblxuaW1wb3J0IHtBdXRoZW50aWNhdGlvblNlcnZpY2V9IGZyb20gJy4uLy4uL3NlcnZpY2VzL0F1dGhlbnRpY2F0aW9uU2VydmljZSc7XG5pbXBvcnQge1Rhc2t9IGZyb20gJ2NvbXBvbmVudHMvdGFza3MvdGFzayc7XG5pbXBvcnQge1Rhc2tTZXJ2aWNlV2Vic29ja2V0c30gZnJvbSAnLi4vLi4vc2VydmljZXMvVGFza1NlcnZpY2VXZWJzb2NrZXRzJztcbmltcG9ydCB7RXZlbnRNYW5hZ2VyfSBmcm9tIFwidXRpbHMvZXZlbnRidXMvRXZlbnRNYW5hZ2VyXCI7XG5cbmltcG9ydCB7Zm9ybURpcmVjdGl2ZXN9IGZyb20gJ2FuZ3VsYXIyL2Zvcm1zJztcblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdjb21wb25lbnQtMicsXG4gICAgdmlld0luamVjdG9yOiBbQXV0aGVudGljYXRpb25TZXJ2aWNlLCBUYXNrU2VydmljZVdlYnNvY2tldHNdXG59KVxuQFZpZXcoe1xuICAgIHRlbXBsYXRlVXJsOiAnLi9jb21wb25lbnRzL3Rhc2tzL3Rhc2tzLmh0bWw/dj08JT0gVkVSU0lPTiAlPicsXG4gICAgZGlyZWN0aXZlczogW05nRm9yLCBOZ0lmLCBmb3JtRGlyZWN0aXZlc11cbn0pXG5leHBvcnQgY2xhc3MgVGFza3Mge1xuICAgIHRhc2tzOiBBcnJheTxUYXNrPjtcblx0dGFzazogVGFzayA9IG5ldyBUYXNrKCk7XG5cdG5yT2ZUYXNrczogbnVtYmVyO1xuICAgIHByaXZhdGUgZXZlbnRNYW5hZ2VyOiBFdmVudE1hbmFnZXIgPSBFdmVudE1hbmFnZXIuZ2V0SW5zdGFuY2UoKTtcblxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBhdXRoZW50aWNhdGlvblNlcnZpY2U6IEF1dGhlbnRpY2F0aW9uU2VydmljZSwgcHVibGljIHRhc2tTZXJ2aWNlOiBUYXNrU2VydmljZVdlYnNvY2tldHMpIHtcbiAgICAgICAgY29uc29sZS5sb2coXCJ0YXNrcy50cyBjb25zdHJ1Y3RvclwiKTtcblxuICAgICAgICBpZiAodGhpcy5hdXRoZW50aWNhdGlvblNlcnZpY2UuaXNMb2dnZWRJbigpKSB7XG4gICAgICAgICAgICB0aGlzLnRhc2tTZXJ2aWNlLnNlbmRNZXNzYWdlKHttZXNzYWdlVHlwZTogXCJHRVRfVEFTS1NfRk9SX1VTRVJcIn0pLnRoZW4oKG9iaikgPT4ge1xuXHQgICAgICAgICAgICBjb25zb2xlLmxvZyhcInRhc2tzIGdvdDogXCIgKyBKU09OLnN0cmluZ2lmeShvYmopKTtcbiAgICAgICAgICAgICAgICB0aGlzLnRhc2tzID0gb2JqO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZmluaXNoZWQgZ2V0dGluZyB0YXNrczogXCIgKyB0aGlzLnRhc2tzLmxlbmd0aCk7XG5cdCAgICAgICAgICAgIHRoaXMubnJPZlRhc2tzID0gdGhpcy50YXNrcy5sZW5ndGg7XG4gICAgICAgICAgICB9KS5jYXRjaCgoZXJyb3IpID0+IHtcblx0ICAgICAgICAgICAgdGhpcy5ldmVudE1hbmFnZXIucHVibGlzaChcInRhc2tzUmVzdWx0XCIsIFtmYWxzZSwgZXJyb3IubWVzc2FnZV0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG5cdCAgICAgICAgdGhpcy5ldmVudE1hbmFnZXIucHVibGlzaChcImF1dGhlbnRpY2F0aW9uU3RhdGVDaGFuZ2VcIiwgW2ZhbHNlLCBcIllvdSBhcmUgbm90IGF1dGhlbnRpY2F0ZWQsIHBsZWFzZSBsb2cgaW4uXCJdKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNhdmVUYXNrKGV2ZW50OiBhbnkpOiB2b2lkIHtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsgLy8gcHJldmVudCBuYXRpdmUgcGFnZSByZWZyZXNoXG5cdCAgICBjb25zb2xlLmxvZyhcImNvbnRyb2xsZXIgc2F2ZVRhc2tcIik7XG4gICAgICAgIGlmICh0aGlzLnRhc2sgJiYgKHRoaXMudGFzay5faWQgPT0gbnVsbCB8fCB0aGlzLnRhc2suX2lkID09IHVuZGVmaW5lZCkpIHtcblx0ICAgICAgICBsZXQgbmV3VGFzayA9IHRoaXMudGFzaztcblx0ICAgICAgICBjb25zb2xlLmxvZyhcImhpZXJcIik7XG5cdCAgICAgICAgdGhpcy50YXNrU2VydmljZS5zZW5kTWVzc2FnZSh0aGlzLnRhc2tTZXJ2aWNlLnNlbmRNZXNzYWdlKHttZXNzYWdlVHlwZTogXCJBRERfVEFTS1wiLCB0YXNrOiBuZXdUYXNrfSkudGhlbigob2JqKSA9PiB7XG5cdFx0ICAgICAgICBjb25zb2xlLmRpcihvYmopO1xuXHRcdCAgICAgICAgbmV3VGFzay5zZXRJZChvYmouX2lkKTtcblx0XHQgICAgICAgIGNvbnNvbGUubG9nKFwiYmVmb3JlIHB1c2g6IFwiICsgdGhpcy50YXNrcy5sZW5ndGgpO1xuXHRcdCAgICAgICAgdGhpcy5uck9mVGFza3MgPSB0aGlzLnRhc2tzLnB1c2gobmV3VGFzayk7XG5cdFx0ICAgICAgICB0aGlzLmV2ZW50TWFuYWdlci5wdWJsaXNoKFwidGFza3NSZXN1bHRcIiwgW3RydWUsIFwiQWRkZWQgdGFzayAnXCIgKyBuZXdUYXNrLmdldElkKCkgKyBcIidcIl0pO1xuXHRcdCAgICAgICAgdGhpcy50YXNrID0gbmV3IFRhc2soKTtcblx0ICAgICAgICB9KS5jYXRjaCgoZXJyb3IpID0+IHtcblx0XHQgICAgICAgIHRoaXMuZXZlbnRNYW5hZ2VyLnB1Ymxpc2goXCJ0YXNrc1Jlc3VsdFwiLCBbZmFsc2UsIGVycm9yLm1lc3NhZ2VdKTtcblx0ICAgICAgICB9KSk7XG4gICAgICAgIH0gZWxzZSB7XG5cdCAgICAgICAgdGhpcy50YXNrU2VydmljZS5zZW5kTWVzc2FnZSh0aGlzLnRhc2tTZXJ2aWNlLnNlbmRNZXNzYWdlKHttZXNzYWdlVHlwZTogXCJVUERBVEVfVEFTS1wiLCB0YXNrOiB0aGlzLnRhc2t9KS50aGVuKChvYmopID0+IHtcblx0XHQgICAgICAgIHRoaXMuZXZlbnRNYW5hZ2VyLnB1Ymxpc2goXCJ0YXNrc1Jlc3VsdFwiLCBbdHJ1ZSwgXCJVcGRhdGVkIHRhc2sgJ1wiICsgdGhpcy50YXNrLl9pZCArIFwiJ1wiXSk7XG5cdFx0ICAgICAgICB0aGlzLnRhc2sgPSBuZXcgVGFzaygpO1xuXHQgICAgICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuXHRcdCAgICAgICAgdGhpcy5ldmVudE1hbmFnZXIucHVibGlzaChcInRhc2tzUmVzdWx0XCIsIFtmYWxzZSwgZXJyb3IubWVzc2FnZV0pO1xuXHQgICAgICAgIH0pKTtcbiAgICAgICAgfVxuICAgIH1cblxuXHRsb2FkVGFzayhldmVudDogYW55LCB0YXNrOiBUYXNrKTogdm9pZCB7XG5cdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTsgLy8gcHJldmVudCBuYXRpdmUgcGFnZSByZWZyZXNoXG5cdFx0Y29uc29sZS5sb2coXCJsb2FkIHRhc2sgXCIgKyB0YXNrLl9pZCk7XG5cdFx0dGhpcy50YXNrID0gdGFzaztcblx0fVxuXG5cdGNsZWFyVGFzayhldmVudDogYW55KTogdm9pZCB7XG5cdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTsgLy8gcHJldmVudCBuYXRpdmUgcGFnZSByZWZyZXNoXG5cdFx0dGhpcy50YXNrID0gbmV3IFRhc2soKTtcblx0fVxuXG5cdGRlbGV0ZVRhc2soZXZlbnQ6IGFueSk6IHZvaWQge1xuXHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7IC8vIHByZXZlbnQgbmF0aXZlIHBhZ2UgcmVmcmVzaFxuXHRcdGNvbnNvbGUubG9nKFwidGFza3MudHMgZGVsZXRlIFwiICsgdGhpcy50YXNrLl9pZCk7XG5cdFx0dGhpcy50YXNrU2VydmljZS5zZW5kTWVzc2FnZSh7bWVzc2FnZVR5cGU6IFwiREVMRVRFX1RBU0tcIiwgdGFzazogdGhpcy50YXNrfSkudGhlbigob2JqKSA9PiB7XG5cdFx0XHR0aGlzLmV2ZW50TWFuYWdlci5wdWJsaXNoKFwidGFza3NSZXN1bHRcIiwgW3RydWUsIFwiRGVsZXRlZCB0YXNrICdcIiArIHRoaXMudGFzay5faWQgKyBcIidcIl0pO1xuXHRcdFx0Ly8gZmluZEluZGV4IGRvZXMgbm90IHdvcmsgb24gVGFza1tdXG5cdFx0XHQvLyB0aGlzLnRhc2tzLnNwbGljZSh0aGlzLnRhc2tzLmZpbmRJbmRleChfdGFzayA9PiBfdGFzay5faWQgPT0gdGhpcy50YXNrLl9pZCkpO1xuXHRcdFx0Zm9yIChsZXQgaSA9IDAsIGxlbiA9IHRoaXMudGFza3MubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcblx0XHRcdFx0bGV0IF90YXNrID0gdGhpcy50YXNrc1tpXTtcblx0XHRcdFx0aWYgKF90YXNrLl9pZCA9PSB0aGlzLnRhc2suX2lkKSB7XG5cdFx0XHRcdFx0Y29uc29sZS5sb2coXCJkZWxldGUgdGFzayB3aXRoIGlkIFwiICsgdGhpcy50YXNrLl9pZCArIFwiLCBcIiArIGkpO1xuXHRcdFx0XHRcdHRoaXMudGFza3Muc3BsaWNlKGkpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHR0aGlzLnRhc2sgPSBuZXcgVGFzaygpO1xuXHRcdH0pLmNhdGNoKChlcnJvcikgPT4ge1xuXHRcdFx0dGhpcy5ldmVudE1hbmFnZXIucHVibGlzaChcInRhc2tzUmVzdWx0XCIsIFtmYWxzZSwgZXJyb3IubWVzc2FnZV0pO1xuXHRcdH0pO1xuXHR9XG59XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=